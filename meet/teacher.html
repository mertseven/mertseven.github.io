<!-- teacher.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Icebreaker Session - Teacher Dashboard</title>
    <link rel="stylesheet" href="neue-style.css">
    <!-- Required JS Libraries -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Class Icebreaker</h1>
        <div id="status">Connecting to the network...</div>
        
        <h2>Session QR Code</h2>
        <p>Ask your students to scan this QR code with their phones to join the session.</p>
        <div id="qrcode"></div>

        <h2>Live Answers</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;">
            <button id="export-btn">Export Answers as CSV</button>
            <button id="start-voting-btn" style="display: none; background-color: #16A34A;">Start Voting</button>
            <button id="clear-btn" style="background-color: #DC2626; display: none;">Clear All Answers</button>
        </div>
        <div id="answers-list">
            <p>No answers received yet...</p>
        </div>

        <div id="voting-results-container" style="display: none;">
            <h2>Voting Results</h2>
            <div id="results-list">
                <p>Waiting for votes...</p>
            </div>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const answersListEl = document.getElementById('answers-list');
        const exportBtn = document.getElementById('export-btn');
        const startVotingBtn = document.getElementById('start-voting-btn');
        const clearBtn = document.getElementById('clear-btn');
        const votingResultsContainer = document.getElementById('voting-results-container');
        const resultsListEl = document.getElementById('results-list');

        let receivedAnswers = [];
        let connections = [];
        let voteCounts = {};
        let isVotingActive = false;

        function saveAnswers() {
            localStorage.setItem('icebreakerAnswers', JSON.stringify(receivedAnswers));
        }

        function loadAnswers() {
            const savedAnswers = localStorage.getItem('icebreakerAnswers');
            if (savedAnswers) {
                receivedAnswers = JSON.parse(savedAnswers);
                if(receivedAnswers.length > 0) {
                    startVotingBtn.style.display = 'block';
                    clearBtn.style.display = 'block';
                }
                renderAnswers();
            }
        }
        
        // --- IMPROVED CONNECTION LOGIC ---
        // We are providing a list of reliable STUN servers from Google 
        // to help establish peer-to-peer connections more reliably across different networks.
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        });

        peer.on('open', function(id) {
            statusEl.textContent = `CONNECTION OPEN! Students can now join.`;
            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
            const studentPageUrl = baseUrl + 'student.html?id=' + id;
            
            new QRCode(document.getElementById("qrcode"), {
                text: studentPageUrl,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });

        peer.on('connection', function(conn) {
            connections.push(conn);
            statusEl.textContent = `A student has connected!`;
            
            conn.on('data', function(data) {
                if (data.type === 'answer') {
                    const isDuplicate = receivedAnswers.some(ans => 
                        (ans.nickname || '').trim().toLowerCase() === (data.payload.nickname || '').trim().toLowerCase()
                    );
                    if (!isDuplicate && data.payload.nickname) {
                        receivedAnswers.push(data.payload);
                        saveAnswers();
                        renderAnswers();
                        statusEl.textContent = `${receivedAnswers.length} answer(s) received!`;
                        if (receivedAnswers.length > 0) {
                            startVotingBtn.style.display = 'block';
                            clearBtn.style.display = 'block';
                        }
                    }
                } else if (data.type === 'vote') {
                    tallyVotes(data.payload);
                } else if (data.type === 'request-state') {
                    if (isVotingActive) {
                        const candidates = receivedAnswers.map((ans, index) => ({ id: index, nickname: ans.nickname, emojis: ans.q2 }));
                        conn.send({ type: 'start-vote', payload: candidates });
                    }
                }
            });

            conn.on('close', () => {
                connections = connections.filter(c => c.peer !== conn.peer);
            });
        });

        function renderAnswers() {
            answersListEl.innerHTML = '';
            if (receivedAnswers.length === 0) {
                answersListEl.innerHTML = '<p>No answers received yet...</p>';
                return;
            }

            receivedAnswers.forEach((answer, index) => {
                const card = document.createElement('div');
                card.className = 'answer-card';
                const nickname = (answer.nickname || 'Anonymous').replace(/</g, "&lt;").replace(/>/g, "&gt;");
                card.innerHTML = `
                    <h3>Answer #${index + 1} - ${nickname}</h3>
                    <p><strong>Explain the internet to someone from 1920:</strong><br>${answer.q1 || ''}</p>
                    <p><strong>Last three emojis used:</strong><br>${answer.q2 || ''}</p>
                    <p><strong>Why study New Media and Communication?</strong><br>${answer.q3 || ''}</p>
                    <p><strong>Superpower:</strong><br>${answer.q4 || ''}</p>
                    <p><strong>Time Machine:</strong><br>${answer.q5 || ''}</p>
                    <p><strong>Learning Method:</strong><br>${answer.q6 || ''}</p>
                    <p><strong>Something interesting about yourself:</strong><br>${answer.q7 || ''}</p>
                `;
                answersListEl.appendChild(card);
            });
        }

        startVotingBtn.addEventListener('click', () => {
            isVotingActive = true;
            const candidates = receivedAnswers.map((ans, index) => ({
                id: index,
                nickname: ans.nickname,
                emojis: ans.q2
            }));

            connections.forEach(conn => {
                conn.send({ type: 'start-vote', payload: candidates });
            });

            statusEl.textContent = "Voting has started!";
            votingResultsContainer.style.display = 'block';
            startVotingBtn.disabled = true;
            startVotingBtn.textContent = "Voting in Progress";
        });

        clearBtn.addEventListener('click', () => {
            if (clearBtn.dataset.confirm) {
                receivedAnswers = [];
                voteCounts = {};
                isVotingActive = false;
                localStorage.removeItem('icebreakerAnswers');
                renderAnswers();
                votingResultsContainer.style.display = 'none';
                resultsListEl.innerHTML = '<p>Waiting for votes...</p>';
                startVotingBtn.style.display = 'none';
                startVotingBtn.disabled = false;
                startVotingBtn.textContent = "Start Voting";
                clearBtn.style.display = 'none';
                statusEl.textContent = "All answers cleared. Ready for a new session.";
                connections.forEach(conn => conn.send({ type: 'reset' }));
                delete clearBtn.dataset.confirm;
                clearBtn.textContent = 'Clear All Answers';
                clearBtn.style.backgroundColor = '#DC2626';
            } else {
                clearBtn.dataset.confirm = 'true';
                clearBtn.textContent = 'Are you sure? Click again to clear.';
                clearBtn.style.backgroundColor = '#F59E0B';
                setTimeout(() => {
                    if (clearBtn.dataset.confirm) {
                        delete clearBtn.dataset.confirm;
                        clearBtn.textContent = 'Clear All Answers';
                        clearBtn.style.backgroundColor = '#DC2626';
                    }
                }, 3000);
            }
        });

        function tallyVotes(voteArray) {
            voteArray.forEach(id => {
                voteCounts[id] = (voteCounts[id] || 0) + 1;
            });
            renderVoteResults();
        }

        function renderVoteResults() {
            resultsListEl.innerHTML = '';
            const sortedVotes = Object.entries(voteCounts).sort((a, b) => b[1] - a[1]);
            if (sortedVotes.length === 0) {
                resultsListEl.innerHTML = '<p>Waiting for votes...</p>';
                return;
            }
            sortedVotes.forEach(([id, count]) => {
                const answer = receivedAnswers[id];
                if (answer) {
                    const resultEl = document.createElement('p');
                    resultEl.innerHTML = `<strong>${(answer.nickname || 'Anonymous').replace(/</g, "&lt;")}</strong>: ${count} vote(s)`;
                    resultsListEl.appendChild(resultEl);
                }
            });
        }

        exportBtn.addEventListener('click', () => {
            if (receivedAnswers.length === 0) {
                alert('There are no answers to export!');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,Nickname,Explain Internet,Last Emojis,Why New Media,Superpower,Time Machine,Learning Method,Interesting Fact\n";
            receivedAnswers.forEach(answer => {
                const row = `"${answer.nickname || ''}","${answer.q1 || ''}","${answer.q2 || ''}","${answer.q3 || ''}","${answer.q4 || ''}","${answer.q5 || ''}","${answer.q6 || ''}","${answer.q7 || ''}"`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "class_icebreaker_answers.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        loadAnswers();
    </script>
</body>
</html>

