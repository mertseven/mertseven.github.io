<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tanışma Etkinliği - Öğretmen Paneli</title>
    <link rel="stylesheet" href="stil.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Sınıf Tanışma Oyunu</h1>
        <div id="durum">Bağlantı kuruluyor...</div>
        
        <h2>Derse Katılım Kodu</h2>
        <p>Öğrencilerin telefonlarıyla aşağıdaki QR kodu okutarak bağlanmasını sağlayın.</p>
        <div id="qrcode"></div>

        <h2>Gelen Cevaplar</h2>
        <button id="export-btn">Cevapları CSV Olarak İndir</button>
        <div id="cevaplar-listesi">
            <p>Henüz cevap gelmedi...</p>
        </div>
    </div>

    <script>
        const durumEl = document.getElementById('durum');
        const cevaplarListesiEl = document.getElementById('cevaplar-listesi');
        const exportBtn = document.getElementById('export-btn');
        let gelenCevaplar = [];

        // Sayfa yenilendiğinde verileri kaybetmemek için localStorage kullan
        function cevaplariKaydet() {
            localStorage.setItem('tanismaCevaplari', JSON.stringify(gelenCevaplar));
        }

        function cevaplariYukle() {
            const kayitliCevaplar = localStorage.getItem('tanismaCevaplari');
            if (kayitliCevaplar) {
                gelenCevaplar = JSON.parse(kayitliCevaplar);
                cevaplariGoster();
            }
        }
        
        const peer = new Peer();

        peer.on('open', function(id) {
            durumEl.textContent = `BAĞLANTI AÇIK! Öğrenciler katılabilir.`;
            const ogrenciSayfasiUrl = window.location.href.replace('ogretmen.html', 'ogrenci.html') + '?id=' + id;
            
            new QRCode(document.getElementById("qrcode"), {
                text: ogrenciSayfasiUrl,
                width: 256,
                height: 256,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });
        });

        peer.on('connection', function(conn) {
            durumEl.textContent = `Bir öğrenci bağlandı! Cevap bekleniyor...`;
            conn.on('data', function(data) {
                gelenCevaplar.push(data);
                cevaplariKaydet();
                cevaplariGoster();
                durumEl.textContent = `${gelenCevaplar.length} cevap geldi!`;
            });
        });

        function cevaplariGoster() {
            cevaplarListesiEl.innerHTML = '';
            if (gelenCevaplar.length === 0) {
                cevaplarListesiEl.innerHTML = '<p>Henüz cevap gelmedi...</p>';
                return;
            }

            gelenCevaplar.forEach((cevap, index) => {
                const kart = document.createElement('div');
                kart.className = 'cevap-kartı';
                kart.innerHTML = `
                    <h3>Cevap #${index + 1}</h3>
                    <p><strong>Süper Güç:</strong> ${cevap.q1}</p>
                    <p><strong>Zaman Makinesi:</strong> ${cevap.q2}</p>
                    <p><strong>En İyi Öğrenme Yöntemi:</strong> ${cevap.q3}</p>
                `;
                cevaplarListesiEl.appendChild(kart);
            });
        }

        exportBtn.addEventListener('click', () => {
            if (gelenCevaplar.length === 0) {
                alert('İndirilecek cevap bulunmuyor!');
                return;
            }
            let csvContent = "data:text/csv;charset=utf-8,Süper Güç,Zaman Makinesi,Öğrenme Yöntemi\n";
            gelenCevaplar.forEach(cevap => {
                const row = `"${cevap.q1}","${cevap.q2}","${cevap.q3}"`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sinif_tanisma_cevaplari.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Sayfa yüklendiğinde eski cevapları yükle
        cevaplariYukle();
    </script>
</body>
</html>