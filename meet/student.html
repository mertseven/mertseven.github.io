<!-- student.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Icebreaker Session - Answer</title>
    <link rel="stylesheet" href="neue-style.css">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 id="main-header">Welcome to the Game!</h1>
        <div id="status">Connecting to the teacher...</div>

        <form id="answer-form" style="display: none;">
             <div class="question-block">
                <label for="nickname">What is your nickname? (If you don't have one, make one up!)</label>
                <input type="text" id="nickname" name="nickname" required style="width: 100%; font-size: 1rem; padding: 0.75rem; margin-top: 0.5rem; border-radius: 0.5rem; border: 2px solid #D1D5DB; font-family: inherit;">
            </div>
            <div class="question-block">
                <label for="q1">If you had to explain the internet to someone from the year 1920, what would you say?</label>
                <textarea id="q1" name="q1" required></textarea>
            </div>
            <div class="question-block">
                <label for="q2">Put the last three emojis you used.</label>
                <input type="text" id="q2" name="q2" required style="width: 100%; font-size: 1rem; padding: 0.75rem; margin-top: 0.5rem; border-radius: 0.5rem; border: 2px solid #D1D5DB; font-family: inherit;">
            </div>
            <div class="question-block">
                <label for="q3">Why did you choose to study New Media and Communication?</label>
                <textarea id="q3" name="q3" required></textarea>
            </div>
            <div class="question-block">
                <label for="q4">If you had a superpower, what would it be?</label>
                <textarea id="q4" name="q4" required></textarea>
            </div>
            <div class="question-block">
                <label for="q5">If you had a time machine, what year would you go to and why?</label>
                <textarea id="q5" name="q5" required></textarea>
            </div>
            <div class="question-block">
                <label for="q6">How do you learn best? (e.g., by reading, listening, doing, discussing?)</label>
                <textarea id="q6" name="q6" required></textarea>
            </div>
            <button type="submit">Send My Answers!</button>
        </form>

        <div id="voting-area" style="display:none;">
            <p>Remember participants by their emoji answers.</p>
            <form id="voting-form">
                <div id="candidates-list" style="margin-top: 1.5rem;"></div>
                <button type="submit">Submit My 3 Votes</button>
            </form>
        </div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const mainHeaderEl = document.getElementById('main-header');
        const answerFormEl = document.getElementById('answer-form');
        const votingAreaEl = document.getElementById('voting-area');
        const candidatesListEl = document.getElementById('candidates-list');
        const votingFormEl = document.getElementById('voting-form');

        document.querySelectorAll('input[type="text"]').forEach(input => {
            input.addEventListener('focus', () => { input.style.borderColor = '#4F46E5'; input.style.boxShadow = '0 0 0 3px rgba(79, 70, 229, 0.3)'; input.style.outline = 'none'; });
            input.addEventListener('blur', () => { input.style.borderColor = '#D1D5DB'; input.style.boxShadow = 'none'; });
        });

        const params = new URLSearchParams(window.location.search);
        const teacherId = params.get('id');

        if (!teacherId) {
            statusEl.textContent = 'ERROR: Teacher ID not found. Please scan the QR code again.';
        } else {
            const submissionFlag = `submitted_to_${teacherId}`; // Flag is specific to this session
            const hasSubmitted = localStorage.getItem(submissionFlag);
            let conn; // Make conn accessible in the scope

            const peer = new Peer();
            peer.on('open', function(id) {
                conn = peer.connect(teacherId);
                conn.on('open', function() {
                    
                    if (hasSubmitted) {
                        statusEl.textContent = 'Welcome back! Waiting for voting to begin...';
                        answerFormEl.style.display = 'none';
                    } else {
                        statusEl.textContent = 'Connected! Please answer the questions below.';
                        answerFormEl.style.display = 'block';
                    }

                    conn.on('data', function(data) {
                        if (data.type === 'start-vote') {
                            displayVotingScreen(data.payload);
                        }
                    });
                });
            });

            answerFormEl.addEventListener('submit', function(e) {
                e.preventDefault();
                const answers = {
                    nickname: document.getElementById('nickname').value,
                    q1: document.getElementById('q1').value, q2: document.getElementById('q2').value,
                    q3: document.getElementById('q3').value, q4: document.getElementById('q4').value,
                    q5: document.getElementById('q5').value, q6: document.getElementById('q6').value
                };
                conn.send({ type: 'answer', payload: answers });
                localStorage.setItem(submissionFlag, 'true'); // Set flag after submitting
                statusEl.textContent = 'Awesome! Your answers have been sent. Waiting for voting to begin...';
                answerFormEl.style.display = 'none';
            });

            votingFormEl.addEventListener('submit', function(e) {
                e.preventDefault();
                const selectedVotes = [];
                const checkboxes = document.querySelectorAll('#candidates-list input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    selectedVotes.push(checkbox.value);
                });
                if (selectedVotes.length > 3) {
                    alert('Please select a maximum of 3 candidates.');
                    return;
                }
                conn.send({ type: 'vote', payload: selectedVotes });
                votingAreaEl.style.display = 'none';
                statusEl.textContent = 'Thank you for voting!';
            });

            function displayVotingScreen(candidates) {
                mainHeaderEl.textContent = 'Vote for your favorite 3 answers!';
                statusEl.style.display = 'none';
                answerFormEl.style.display = 'none'; // Hide answer form if it wasn't already
                votingAreaEl.style.display = 'block';
                candidatesListEl.innerHTML = ''; // Clear previous candidates if any

                candidates.forEach(candidate => {
                    const div = document.createElement('div');
                    div.style.cssText = 'display: flex; align-items: center; margin-bottom: 0.75rem;';
                    // FIX: Safely handle nickname and emojis in case they are undefined.
                    const nickname = candidate.nickname || 'Anonymous';
                    const emojis = candidate.emojis || '';
                    div.innerHTML = `
                        <input type="checkbox" id="candidate-${candidate.id}" value="${candidate.id}" style="width: 1.25rem; height: 1.25rem; margin-right: 0.75rem;">
                        <label for="candidate-${candidate.id}" style="font-size: 1.1rem;">
                            <strong>${nickname.replace(/</g, "&lt;")}</strong> - (${emojis.replace(/</g, "&lt;")})
                        </label>
                    `;
                    candidatesListEl.appendChild(div);
                });
                
                candidatesListEl.addEventListener('change', (e) => {
                    const checkedCount = document.querySelectorAll('#candidates-list input[type="checkbox"]:checked').length;
                    if (checkedCount > 3) {
                        e.target.checked = false;
                        alert('You can only select up to 3 candidates.');
                    }
                });
            }
        }
    </script>
</body>
</html>

